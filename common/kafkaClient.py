# from kafka import KafkaConsumer
import time,json,sys,os
sys.path.append(os.path.realpath('.'))
from kafka import KafkaConsumer
from kafka import KafkaProducer
from pykafka import KafkaClient


class KafkaTest(object):
    def __init__(self, host):
        self.host = host;self.client = KafkaClient(hosts=self.host)
        # print(self.client.topics)  # 所有的topic
        # print(self.client.brokers)  # kafka的所有的brokers
    def balance_consumer(self, topic, offset=0):
        topic = self.client.topics[topic.encode()]
        # managed=True 设置后，使用新式reblance分区方法，不需要使用zk，而False是通过zk来实现reblance的需要使用zk,必须指定 # zookeeper_connect = "zookeeperIp",consumer_group='test_group',
        consumer = topic.get_balanced_consumer(auto_commit_enable=True,managed=True,consumer_group=b'HpDailyDataConsumerGroup0000002',consumer_timeout_ms=300000
            # managed=False,
            # zookeeper_connect="10.111.64.225:2181",
        )
        partitions = topic.partitions
        # print("所有的分区：{}".format(partitions))
        # earliest_offsets = topic.earliest_available_offsets()
        # print("最早可用offset：{}".format(earliest_offsets))
        # last_offsets = topic.latest_available_offsets()
        # print("最近可用offset：{}".format(last_offsets))
        offset = consumer.held_offsets
        print("当前消费者分区offset情况：{}".format(offset))
        # last_offset_number=str(last_offsets)[str(last_offsets).find('[')+1:str(last_offsets).find(']')]
        while True:
            msg = consumer.consume()
            offset = consumer.held_offsets
            # print(offset,last_offset_number,last_offset_number==offset)
            # print(int(str(offset)[3:-1])==int(last_offset_number)-1)
            # print(111,offset, msg.value.de code())
            if str(msg.value.decode())!='':
                print(offset,msg.value.decode())
            # if msg:
            #     offset = consumer.held_offsets
            #     print("当前位移：{}".format(offset))
            #     # result.append(eval(msg.value.decode()))
            #     # print(msg.value.decode()=='')
            #     print(msg.value.decode())
            #     consumer.commit_offsets()  # commit一下

            # else:
            #     print("没有数据")
if __name__ == '__main__':
    produce_flag=0;comsumer_flag=0;
    # host = 'kafka2-test1.sinnet.huobiidc.com:9092,kafka2-test2.sinnet.huobiidc.com:9092,kafka2-test3.sinnet.huobiidc.com:9092'  #光环 测试环境
    # host='172.18.170.97:9092,172.18.169.248:9092,172.18.170.195:9092'
    host = '172.18.174.35:9092,172.18.172.156:9092,172.18.172.211:9092' #华为云new test20、new test5
    kafka_ins = KafkaTest(host)
    if comsumer_flag:
        topic = 'test20_mgt_symbols_config_2'
        # topic = 'brian1'
        kafka_ins.balance_consumer(topic)
        print('kcat -b '+host+' -t '+topic+' -o 1')
        # consumer = KafkaConsumer('test20_mgt_symbols_config', bootstrap_servers=['kafka2-test1.sinnet.huobiidc.com:9092'])
        # for msg in consumer:
        #     recv = "%s:%d:%d: key=%s value=%s" % (msg.topic, msg.partition, msg.offset, msg.key, msg.value)
        #     print(recv)
    if produce_flag:
        producer = KafkaProducer(bootstrap_servers=host);msg='test5_mgt_symbols_config'
        client = KafkaClient(hosts=host)
        # js={"BTC-USDT-220318": {"contr-exchange-type": 2, "name": "BTC-USDT-220318", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000719}, "BTC-USDT-220325": {"contr-exchange-type": 2, "name": "BTC-USDT-220325", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000720}, "BTC-USDT-220401": {"contr-exchange-type": 2, "name": "BTC-USDT-220401", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000721}, "BTC-USDT-220408": {"contr-exchange-type": 2, "name": "BTC-USDT-220408", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000722}, "BTC-USDT-220415": {"contr-exchange-type": 2, "name": "BTC-USDT-220415", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000723}, "BTC-USDT-220422": {"contr-exchange-type": 2, "name": "BTC-USDT-220422", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000724}, "BTC-USDT-220429": {"contr-exchange-type": 2, "name": "BTC-USDT-220429", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000725}, "BTC-USDT-220506": {"contr-exchange-type": 2, "name": "BTC-USDT-220506", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000726}, "BTC-USDT-220513": {"contr-exchange-type": 2, "name": "BTC-USDT-220513", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000727}, "BTC-USDT-220520": {"contr-exchange-type": 2, "name": "BTC-USDT-220520", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000728}, "BTC-USDT-220624": {"contr-exchange-type": 2, "name": "BTC-USDT-220624", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000729}, "BTC-USDT-220930": {"contr-exchange-type": 2, "name": "BTC-USDT-220930", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000730}, "BTC-HUSD-220318": {"contr-exchange-type": 2, "name": "BTC-HUSD-220318", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000731}, "BTC-HUSD-220325": {"contr-exchange-type": 2, "name": "BTC-HUSD-220325", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000732}, "BTC-HUSD-220401": {"contr-exchange-type": 2, "name": "BTC-HUSD-220401", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000733}, "BTC-HUSD-220408": {"contr-exchange-type": 2, "name": "BTC-HUSD-220408", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000734}, "BTC-HUSD-220415": {"contr-exchange-type": 2, "name": "BTC-HUSD-220415", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000735}, "BTC-HUSD-220422": {"contr-exchange-type": 2, "name": "BTC-HUSD-220422", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000736}, "BTC-HUSD-220429": {"contr-exchange-type": 2, "name": "BTC-HUSD-220429", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000737}, "BTC-HUSD-220506": {"contr-exchange-type": 2, "name": "BTC-HUSD-220506", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000738}, "BTC-HUSD-220513": {"contr-exchange-type": 2, "name": "BTC-HUSD-220513", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000739}, "BTC-HUSD-220520": {"contr-exchange-type": 2, "name": "BTC-HUSD-220520", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000740}, "BTC-HUSD-220624": {"contr-exchange-type": 2, "name": "BTC-HUSD-220624", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000741}, "BTC-HUSD-220930": {"contr-exchange-type": 2, "name": "BTC-HUSD-220930", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000742}, "ETH-USDT-220318": {"contr-exchange-type": 2, "name": "ETH-USDT-220318", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000743}, "ETH-USDT-220325": {"contr-exchange-type": 2, "name": "ETH-USDT-220325", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000744}, "ETH-USDT-220401": {"contr-exchange-type": 2, "name": "ETH-USDT-220401", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000745}, "ETH-USDT-220408": {"contr-exchange-type": 2, "name": "ETH-USDT-220408", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000746}, "ETH-USDT-220415": {"contr-exchange-type": 2, "name": "ETH-USDT-220415", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000747}, "ETH-USDT-220422": {"contr-exchange-type": 2, "name": "ETH-USDT-220422", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000748}, "ETH-USDT-220429": {"contr-exchange-type": 2, "name": "ETH-USDT-220429", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000749}, "ETH-USDT-220506": {"contr-exchange-type": 2, "name": "ETH-USDT-220506", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000750}, "ETH-USDT-220513": {"contr-exchange-type": 2, "name": "ETH-USDT-220513", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000751}, "ETH-USDT-220520": {"contr-exchange-type": 2, "name": "ETH-USDT-220520", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000752}, "ETH-USDT-220624": {"contr-exchange-type": 2, "name": "ETH-USDT-220624", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000753}, "ETH-USDT-220930": {"contr-exchange-type": 2, "name": "ETH-USDT-220930", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000754}, "ETH-HUSD-220318": {"contr-exchange-type": 2, "name": "ETH-HUSD-220318", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000755}, "ETH-HUSD-220325": {"contr-exchange-type": 2, "name": "ETH-HUSD-220325", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000756}, "ETH-HUSD-220401": {"contr-exchange-type": 2, "name": "ETH-HUSD-220401", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000757}, "ETH-HUSD-220408": {"contr-exchange-type": 2, "name": "ETH-HUSD-220408", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000758}, "ETH-HUSD-220415": {"contr-exchange-type": 2, "name": "ETH-HUSD-220415", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000759}, "ETH-HUSD-220422": {"contr-exchange-type": 2, "name": "ETH-HUSD-220422", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000760}, "ETH-HUSD-220429": {"contr-exchange-type": 2, "name": "ETH-HUSD-220429", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000761}, "ETH-HUSD-220506": {"contr-exchange-type": 2, "name": "ETH-HUSD-220506", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000762}, "ETH-HUSD-220513": {"contr-exchange-type": 2, "name": "ETH-HUSD-220513", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000763}, "ETH-HUSD-220520": {"contr-exchange-type": 2, "name": "ETH-HUSD-220520", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000764}, "ETH-HUSD-220624": {"contr-exchange-type": 2, "name": "ETH-HUSD-220624", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000765}, "ETH-HUSD-220930": {"contr-exchange-type": 2, "name": "ETH-HUSD-220930", "init-id": "367320000", "exchange": "contract-exchange-2-btc", "cont-usd": 0.001, "instrument-id": 21000766}}
        # js={"BTC210924": {"contr-exchange-type": 0, "name": "BTC210924", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000719}, "BTC211001": {"contr-exchange-type": 0, "name": "BTC211001", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000720}, "BTC211008": {"contr-exchange-type": 0, "name": "BTC211008", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000721}, "BTC211231": {"contr-exchange-type": 0, "name": "BTC211231", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000722}, "BTC220325": {"contr-exchange-type": 0, "name": "BTC220325", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000723}}
        js={"BTC220408": {"contr-exchange-type": 0, "name": "BTC220408", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000719}, "BTC220415": {"contr-exchange-type": 0, "name": "BTC220415", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000720}, "BTC220422": {"contr-exchange-type": 0, "name": "BTC220422", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000721}, "BTC220429": {"contr-exchange-type": 0, "name": "BTC220429", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000722}, "BTC220506": {"contr-exchange-type": 0, "name": "BTC220506", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000723}, "BTC220513": {"contr-exchange-type": 0, "name": "BTC220513", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000724}, "BTC220520": {"contr-exchange-type": 0, "name": "BTC220520", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000725}, "BTC220624": {"contr-exchange-type": 0, "name": "BTC220624", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000726}, "BTC220930": {"contr-exchange-type": 0, "name": "BTC220930", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000727}, "ETH220408": {"contr-exchange-type": 0, "name": "ETH220408", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000728}, "ETH220415": {"contr-exchange-type": 0, "name": "ETH220415", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000729}, "ETH220422": {"contr-exchange-type": 0, "name": "ETH220422", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000730}, "ETH220429": {"contr-exchange-type": 0, "name": "ETH220429", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000731}, "ETH220506": {"contr-exchange-type": 0, "name": "ETH220506", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000732}, "ETH220513": {"contr-exchange-type": 0, "name": "ETH220513", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000733}, "ETH220520": {"contr-exchange-type": 0, "name": "ETH220520", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000734}, "ETH220624": {"contr-exchange-type": 0, "name": "ETH220624", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000735}, "ETH220930": {"contr-exchange-type": 0, "name": "ETH220930", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000736}, "EOS220408": {"contr-exchange-type": 0, "name": "EOS220408", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000737}, "EOS220415": {"contr-exchange-type": 0, "name": "EOS220415", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000738}, "EOS220422": {"contr-exchange-type": 0, "name": "EOS220422", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000739}, "EOS220429": {"contr-exchange-type": 0, "name": "EOS220429", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000740}, "EOS220506": {"contr-exchange-type": 0, "name": "EOS220506", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000741}, "EOS220513": {"contr-exchange-type": 0, "name": "EOS220513", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000742}, "EOS220520": {"contr-exchange-type": 0, "name": "EOS220520", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000743}, "EOS220624": {"contr-exchange-type": 0, "name": "EOS220624", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000744}, "EOS220930": {"contr-exchange-type": 0, "name": "EOS220930", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000745}, "LTC220408": {"contr-exchange-type": 0, "name": "LTC220408", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000746}, "LTC220415": {"contr-exchange-type": 0, "name": "LTC220415", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000747}, "LTC220422": {"contr-exchange-type": 0, "name": "LTC220422", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000748}, "LTC220429": {"contr-exchange-type": 0, "name": "LTC220429", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000749}, "LTC220506": {"contr-exchange-type": 0, "name": "LTC220506", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000750}, "LTC220513": {"contr-exchange-type": 0, "name": "LTC220513", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000751}, "LTC220520": {"contr-exchange-type": 0, "name": "LTC220520", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000752}, "LTC220624": {"contr-exchange-type": 0, "name": "LTC220624", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000753}, "LTC220930": {"contr-exchange-type": 0, "name": "LTC220930", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000754}}
        # for i in range(0, 1):
        #     producer.send('brian', value=str('2321her').encode(), key=None, headers=None, partition=None,timestamp_ms=None)
        #
        # # Block直到单条消息发送完或者超时
        #
        # future = producer.send('test5_mgt_symbols_config', value=b'{"BTC210924": {"contr-exchange-type": 0, "name": "BTC210924", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000719}, "BTC211001": {"contr-exchange-type": 0, "name": "BTC211001", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000720}, "BTC211008": {"contr-exchange-type": 0, "name": "BTC211008", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000721}, "BTC211231": {"contr-exchange-type": 0, "name": "BTC211231", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000722}, "BTC220325": {"contr-exchange-type": 0, "name": "BTC220325", "init-id": "367320000", "exchange": "contract-exchange-btc", "cont-usd": 100, "instrument-id": 21000723}}', key=b'othermsg')
        future = producer.send('test5_mgt_symbols_config', value=json.dumps(js).encode(), key=b'othermsg')
        result = future.get(timeout=60)
        print(result)
